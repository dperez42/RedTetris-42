<template>
  <div class="container">
    <div v-if="!game">
      <button class="button" @click="clickJoin">Join</button>
    </div>

    <div v-else class="game-layout">
      <!-- Game Info -->
      <div class="game-info">
        <h2>{{ game.name }}</h2>
      </div>

      <!-- Left Panel: Other Players' Boards -->
      <aside class="left-panel" v-if="otherPlayers.length">
        <h2>Galer√≠a de Tableros</h2>
        <div class="gallery">
          <div v-for="(player, index) in otherPlayers" :key="index">
            <p>Player: {{ player.name }}</p>
            <Spectrum :room_name="game.name" :game="player" />
          </div>
        </div>
      </aside>

      <!-- Right Panel: Your Board & Controls -->
      <main class="right-panel" v-if="myPlayer">
        <Game :room_name="game.name" :game="myPlayer" :type="game.isOnePlayer" />

        <div class="buttons-wrapper">
          <!-- Mode selection -->
          <div v-if="isHost && !game.isCountdown && !game.isStart" class="mode-buttons">
            <button v-for="m in modes" :key="m.value" :class="{ active: mode === m.value }"
                    @click="clickMode(m.value)">
              {{ m.label }}
            </button>
            <button v-for="m in especial_modes" :key="m.value" :class="{ active: ghost_mode }"
                    @click="clickEspecialMode">
              {{ m.label }}
            </button>
          </div>

          <!-- Game action buttons -->
          <div class="action-buttons">
            <button v-if="isHost && !game.isCountdown && !game.isStart" class="start-button"
                    @click="clickStart">Start</button>
            <button v-if="!game.isCountdown && !game.isStart" class="start-button"
                    @click="clickRanking">Ranking</button>
            <button v-if="isHost && !game.isCountdown && game.isStart" class="start-button"
                    @click="clickPause">{{ game.isPause ? "Continue" : "Pause" }}</button>
            <button v-if="isHost && !game.isCountdown && game.isStart" class="start-button"
                    @click="clickReStart">ReStart</button>
          </div>
        </div>
      </main>

      <!-- Countdown Overlay -->
      <div v-if="game.isCountdown" class="overlay_countdown">
        <div class="popup_countdown">
          <h1>{{ game.name }}</h1>
          <h3 class="popup_count">Start in {{ game.countdown }} seconds...</h3>
        </div>
      </div>

      <!-- Finish Overlay -->
      <div v-if="game.isFinish" class="overlay_countdown">
        <div class="popup_countdown">
          <h1>{{ game.name }}</h1>
          <h3 class="popup_count">
            {{ myPlayer?.socket === game.winner_socket ? 'YOU WIN' : 'The game is finished' }}
          </h3>
        </div>
      </div>

      <!-- Ranking Overlay -->
      <div v-if="ranking && game.ranking?.length" class="overlay_countdown">
        <div class="popup_ranking">
          <h1 class="ranking-title">üèÜ HALL OF FAME üèÜ</h1>
          <div class="ranking-table crt-overlay">
            <div v-for="(user, index) in game.ranking" :key="index" class="ranking-row">
              <div class="ranking-name">{{ index + 1 }}. {{ user.name }}</div>
              <div class="ranking-score">{{ user.score }}</div>
            </div>
          </div>
          <button class="retro-button" @click="clickRanking">CLOSE</button>
        </div>
      </div>

    </div>
  </div>
</template>

<script>
import { ref, computed } from 'vue';
import { socket } from '../services/sockets';
import Game from './subcomponents/game.vue';
import Spectrum from './subcomponents/spectrum.vue';
import TetrisInfo from './subcomponents/tetris_info.vue';
import store from '../store/index';

export default {
  name: 'Home',
  components: { Game, Spectrum, TetrisInfo },
  data() {
    return {
      modes: [
        { label: 'üü¢ Easy', value: 'easy' },
        { label: 'üü† Medium', value: 'medium' },
        { label: 'üî¥ Hard', value: 'hard' },
      ],
      especial_modes: [{ label: 'üëª Ghost', value: 'ghost' }],
      mode: 'medium',
      ghost_mode: false,
      ranking: false
    };
  },
  computed: {
    game() {
      return store.state.games_store.game || null;
    },
    socket_id() {
      return store.state.games_store.socket;
    },
    myPlayer() {
      return this.game?.players?.find(p => p.socket === this.socket_id) || null;
    },
    otherPlayers() {
      return this.game?.players?.filter(p => p.socket !== this.socket_id) || [];
    },
    isHost() {
      return this.myPlayer && this.game?.players?.[0]?.socket === this.socket_id;
    }
  },
  methods: {
    clickJoin() {
      socket.emit('red_tetris_server', { command: 'join', playerName: 'Dani', roomName: 'test' });
    },
    clickStart() {
      socket.emit('red_tetris_server', {
        command: 'start',
        gameName: this.game?.name,
        mode: this.mode === 'medium' ? 500 : this.mode === 'hard' ? 250 : 1000,
        ghost_mode: this.ghost_mode
      });
    },
    clickPause() {
      socket.emit('red_tetris_server', { command: 'pause', gameName: this.game?.name });
    },
    clickReStart() {
      socket.emit('red_tetris_server', {
        command: 'restart',
        gameName: this.game?.name,
        mode: this.mode === 'medium' ? 500 : this.mode === 'hard' ? 250 : 1000,
        ghost: this.ghost_mode
      });
    },
    clickMode(mode) { this.mode = mode; },
    clickEspecialMode() { this.ghost_mode = !this.ghost_mode; },
    clickRanking() { this.ranking = !this.ranking; },
    keyHandler(event) {
      if (!this.game?.isPause && ['ArrowDown', 'ArrowUp', 'ArrowRight', 'ArrowLeft', ' ', 'Escape'].includes(event.key)) {
        const msg = { command: 'move', gameName: this.game?.name, playerSocket: this.socket_id, move: event.key };
        if (this.game?.isStart) socket.emit('red_tetris_server', msg);
      }
    }
  },
  beforeMount() {
    document.body.addEventListener('keydown', this.keyHandler);
  },
  beforeUnmount() {
    document.body.removeEventListener('keydown', this.keyHandler);
  }
};
</script>
